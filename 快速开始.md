# 服务器部署快速开始

## 1. 环境准备

### 系统要求
- Ubuntu 18.04+ 或 CentOS 7+
- Python 3.7+
- 摄像头或视频输入设备
- 至少2GB RAM

### 检查系统
```bash
# 检查Python版本
python3 --version

# 检查摄像头设备
ls /dev/video*

# 检查系统类型
cat /etc/os-release
```

## 2. 一键部署

### 下载项目
```bash
# 上传项目文件到服务器
scp -r ddd/ user@server:/tmp/
```

### 运行部署脚本
```bash
cd /tmp/ddd
chmod +x deploy.sh
sudo ./deploy.sh
```

部署脚本会自动：
- 安装系统依赖
- 创建应用用户和目录
- 设置Python环境
- 下载模型文件
- 配置systemd服务
- 运行系统测试

## 3. 启动服务

### 启动推理服务
```bash
# 启动服务
sudo systemctl start drowsiness-detection

# 检查状态
sudo systemctl status drowsiness-detection

# 查看日志
sudo journalctl -u drowsiness-detection -f
```

### 手动运行 (测试用)
```bash
cd /opt/drowsiness-detection

# 基础推理
sudo -u drowsiness ./venv/bin/python server_inference.py

# 指定参数
sudo -u drowsiness ./venv/bin/python server_inference.py \
  --source 0 \
  --duration 3600 \
  --ear-threshold 0.3
```

## 4. 验证部署

### 检查服务状态
```bash
# 服务状态
sudo systemctl is-active drowsiness-detection

# 进程检查
ps aux | grep drowsiness

# 端口检查 (如果有web接口)
netstat -tlnp | grep :8080
```

### 查看结果
```bash
# 查看日志
tail -f /var/log/drowsiness-detection/inference.log

# 查看输出文件
ls -la /opt/drowsiness-detection/output/

# 查看最新结果
cat /opt/drowsiness-detection/output/inference_results_*.json | tail -20
```

## 5. 配置调优

### 修改配置
```bash
# 编辑配置文件
sudo vim /opt/drowsiness-detection/config.py

# 重启服务使配置生效
sudo systemctl restart drowsiness-detection
```

### 性能监控
```bash
# CPU和内存使用率
top -p $(pgrep -f drowsiness)

# GPU使用率 (如果有GPU)
nvidia-smi

# 磁盘空间
df -h /opt/drowsiness-detection/
```

## 6. 常见问题

### 摄像头权限问题
```bash
# 添加用户到video组
sudo usermod -a -G video drowsiness

# 检查设备权限
ls -la /dev/video0
```

### 依赖安装失败
```bash
# 更新系统包
sudo apt update && sudo apt upgrade -y

# 手动安装OpenCV
sudo apt install python3-opencv

# 手动安装dlib
sudo apt install libdlib-dev
```

### 服务无法启动
```bash
# 查看详细错误
sudo journalctl -u drowsiness-detection --no-pager

# 检查配置文件
sudo -u drowsiness /opt/drowsiness-detection/venv/bin/python -c "import config; print('OK')"

# 测试摄像头
sudo -u drowsiness /opt/drowsiness-detection/venv/bin/python test_system.py
```

### 内存不足
```bash
# 创建swap文件
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

## 7. 高级配置

### 多摄像头支持
```bash
# 查看所有摄像头
v4l2-ctl --list-devices

# 启动多个服务实例
sudo systemctl start drowsiness-detection@0
sudo systemctl start drowsiness-detection@1
```

### 远程访问
```bash
# 安装Web界面 (可选)
sudo -u drowsiness ./venv/bin/pip install flask flask-socketio

# 启动Web服务
sudo -u drowsiness ./venv/bin/python web_interface.py
```

### 日志轮转
```bash
# 配置logrotate
sudo tee /etc/logrotate.d/drowsiness-detection << 'EOF'
/var/log/drowsiness-detection/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 644 drowsiness drowsiness
}
EOF
```

## 8. 维护操作

### 定期维护
```bash
# 清理旧日志
find /var/log/drowsiness-detection/ -name "*.log" -mtime +7 -delete

# 清理旧结果文件
find /opt/drowsiness-detection/output/ -name "*.json" -mtime +30 -delete

# 更新依赖
sudo -u drowsiness /opt/drowsiness-detection/venv/bin/pip install --upgrade -r requirements.txt
```

### 备份配置
```bash
# 备份配置
sudo tar -czf drowsiness-backup-$(date +%Y%m%d).tar.gz \
  /opt/drowsiness-detection/config.py \
  /etc/systemd/system/drowsiness-detection.service

# 恢复配置
sudo tar -xzf drowsiness-backup-*.tar.gz -C /
sudo systemctl daemon-reload
```

### 监控脚本
```bash
#!/bin/bash
# 创建监控脚本
sudo tee /usr/local/bin/monitor-drowsiness.sh << 'EOF'
#!/bin/bash
SERVICE="drowsiness-detection"
if ! systemctl is-active --quiet $SERVICE; then
    echo "$(date): $SERVICE is down, restarting..."
    systemctl restart $SERVICE
    sleep 10
    if systemctl is-active --quiet $SERVICE; then
        echo "$(date): $SERVICE restarted successfully"
    else
        echo "$(date): Failed to restart $SERVICE"
        # 发送告警邮件等
    fi
fi
EOF

sudo chmod +x /usr/local/bin/monitor-drowsiness.sh

# 添加到crontab
(crontab -l 2>/dev/null; echo "*/5 * * * * /usr/local/bin/monitor-drowsiness.sh") | crontab -
```

## 9. 卸载服务

```bash
# 停止并禁用服务
sudo systemctl stop drowsiness-detection
sudo systemctl disable drowsiness-detection

# 删除服务文件
sudo rm /etc/systemd/system/drowsiness-detection.service

# 删除应用目录
sudo rm -rf /opt/drowsiness-detection

# 删除用户
sudo userdel drowsiness

# 重载systemd
sudo systemctl daemon-reload
```

## 10. 技术支持

如有问题，请提供以下信息：
1. 系统版本: `cat /etc/os-release`
2. Python版本: `python3 --version`
3. 服务状态: `sudo systemctl status drowsiness-detection`
4. 错误日志: `sudo journalctl -u drowsiness-detection --no-pager`
5. 系统资源: `free -h && df -h`